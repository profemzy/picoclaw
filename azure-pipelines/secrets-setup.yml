# =============================================================================
# Pipeline: PicoClaw Agent Secrets Setup
# Purpose: One-time setup of PicoClaw agent secrets in Azure Key Vault
# Triggers: Manual only
#
# Usage: Run this pipeline once per environment to populate Key Vault with
# PicoClaw-specific secrets (Telegram bot token, Fuelix API key, Oluto agent
# credentials). These are consumed by the ExternalSecrets Operator to create
# the picoclaw-config K8s secret.
# =============================================================================

trigger: none

name: "PicoClaw Agent Secrets Setup"

parameters:
  - name: environment
    displayName: "Target Environment"
    type: string
    default: "dev"
    values:
      - dev
      - prod

  - name: telegramToken
    displayName: "Telegram Bot Token"
    type: string

  - name: fuelixApiKey
    displayName: "Fuelix API Key (LLM provider)"
    type: string

  - name: fuelixBaseUrl
    displayName: "Fuelix Base URL"
    type: string
    default: "https://api.fuelix.ai/v1"

  - name: fuelixModel
    displayName: "Fuelix Model Name"
    type: string
    default: "gemini-3-flash"

  - name: olutoAgentEmail
    displayName: "Oluto Agent Email/Username"
    type: string
    default: "oluto-agent"

  - name: olutoAgentPassword
    displayName: "Oluto Agent Password (LedgerForge)"
    type: string

  - name: olutoBusinessId
    displayName: "Oluto Default Business ID"
    type: string
    default: "f0248a73-9cdb-408e-a22a-855d21d72373"

variables:
  azureServiceConnection: "terraformiacdevops1"

stages:
  - stage: Setup_Secrets
    displayName: "Setup PicoClaw Secrets (${{ parameters.environment }})"
    jobs:
      - job: Populate_KeyVault
        displayName: "Populate Key Vault Secrets"
        pool:
          vmImage: "ubuntu-24.04"
        steps:
          - task: AzureCLI@2
            displayName: "Set PicoClaw Secrets in Key Vault"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                KV_NAME="wackopscoach-${{ parameters.environment }}-kv"
                echo "Setting PicoClaw secrets in Key Vault: $KV_NAME"

                # Telegram bot token
                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "picoclaw-telegram-token" \
                  --value "${{ parameters.telegramToken }}" \
                  --output none

                # Fuelix LLM provider
                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "picoclaw-fuelix-api-key" \
                  --value "${{ parameters.fuelixApiKey }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "picoclaw-fuelix-base-url" \
                  --value "${{ parameters.fuelixBaseUrl }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "picoclaw-fuelix-model" \
                  --value "${{ parameters.fuelixModel }}" \
                  --output none

                # Oluto agent credentials (for LedgerForge API access)
                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "picoclaw-oluto-email" \
                  --value "${{ parameters.olutoAgentEmail }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "picoclaw-oluto-password" \
                  --value "${{ parameters.olutoAgentPassword }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "picoclaw-oluto-business-id" \
                  --value "${{ parameters.olutoBusinessId }}" \
                  --output none

                echo "All PicoClaw secrets set successfully in $KV_NAME"

          - task: AzureCLI@2
            displayName: "Verify Secrets"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                KV_NAME="wackopscoach-${{ parameters.environment }}-kv"
                echo "Verifying PicoClaw secrets in $KV_NAME..."

                SECRETS=(
                  "picoclaw-telegram-token"
                  "picoclaw-fuelix-api-key"
                  "picoclaw-fuelix-base-url"
                  "picoclaw-fuelix-model"
                  "picoclaw-oluto-email"
                  "picoclaw-oluto-password"
                  "picoclaw-oluto-business-id"
                )

                for SECRET in "${SECRETS[@]}"; do
                  if az keyvault secret show --vault-name "$KV_NAME" --name "$SECRET" --query "name" -o tsv > /dev/null 2>&1; then
                    echo "  $SECRET: OK"
                  else
                    echo "  $SECRET: MISSING"
                    exit 1
                  fi
                done

                echo "All PicoClaw secrets verified!"
